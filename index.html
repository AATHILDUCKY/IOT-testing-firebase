<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Energy Meter — Live (Minimal)</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* tiny fade to make updates readable without reflows */
    .tick { transition: opacity .15s ease; }
    .tick.upd { opacity: .6; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <!-- Top Bar -->
  <header class="sticky top-0 z-10 backdrop-blur bg-slate-900/70 border-b border-slate-800">
    <div class="mx-auto max-w-4xl px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 grid place-content-center text-xs font-bold">SE</div>
        <div>
          <h1 class="text-base sm:text-lg font-semibold tracking-tight">Smart Energy Meter — Live</h1>
          <p class="text-[11px] text-slate-400">ESP32 · EmonLib · Firebase (read-only)</p>
        </div>
      </div>

      <div class="flex items-center gap-2 text-[11px]">
        <span id="statusDot" class="inline-block h-2.5 w-2.5 rounded-full bg-yellow-400 animate-pulse"></span>
        <span id="statusText" class="text-slate-300">Connecting…</span>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-4xl px-4 py-6 space-y-6">
    <!-- Config (edit if needed) -->
    <section class="hidden">
      <code id="dbUrl">https://iot-based-smart-energy-m-1b7ba-default-rtdb.asia-southeast1.firebasedatabase.app</code>
      <code id="dataPath">/SmartEnergyMeter/meterData</code>
    </section>

    <!-- Cards: simple + lightweight -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4">
        <p class="text-xs uppercase tracking-wide text-slate-400">Voltage (Vrms)</p>
        <div class="mt-2 text-2xl font-semibold tick" id="Vrms">—</div>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4">
        <p class="text-xs uppercase tracking-wide text-slate-400">Current (Irms)</p>
        <div class="mt-2 text-2xl font-semibold tick" id="Irms">—</div>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4">
        <p class="text-xs uppercase tracking-wide text-slate-400">Real Power (W)</p>
        <div class="mt-2 text-2xl font-semibold tick" id="RealPower">—</div>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4">
        <p class="text-xs uppercase tracking-wide text-slate-400">Apparent Power (VA)</p>
        <div class="mt-2 text-2xl font-semibold tick" id="ApparentPower">—</div>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4">
        <p class="text-xs uppercase tracking-wide text-slate-400">Power Factor</p>
        <div class="mt-2 text-2xl font-semibold tick" id="PowerFactor">—</div>
        <p class="text-xs text-slate-400 mt-1">Angle: <span class="font-medium tick" id="PhaseAngle_deg">—</span>°</p>
      </div>

      <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4">
        <p class="text-xs uppercase tracking-wide text-slate-400">Energy & Bill</p>
        <div class="mt-2 text-lg">
          <div class="font-semibold tick"><span id="Energy_kWh">—</span> kWh</div>
          <div class="text-slate-300 mt-1">Rs <span class="font-semibold tick" id="Bill_Rs">—</span></div>
        </div>
      </div>
    </section>

    <!-- Relays + Last Update -->
    <section class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4">
        <p class="text-xs uppercase tracking-wide text-slate-400">Relays</p>
        <div class="mt-2 flex items-center gap-3 text-sm">
          <span>R1:</span><span id="Relay1" class="px-2 py-0.5 rounded-md bg-slate-800 text-slate-300 tick">—</span>
          <span class="ml-4">R2:</span><span id="Relay2" class="px-2 py-0.5 rounded-md bg-slate-800 text-slate-300 tick">—</span>
        </div>
      </div>
      <div class="rounded-xl border border-slate-800 bg-slate-900/60 p-4">
        <p class="text-xs uppercase tracking-wide text-slate-400">Last Update</p>
        <div class="mt-2 text-lg font-medium tick" id="lastTs">—</div>
        <p class="text-[11px] text-slate-500 mt-1">Source: <code>/SmartEnergyMeter/meterData</code></p>
      </div>
    </section>
  </main>

  <footer class="mx-auto max-w-4xl px-4 pb-8 pt-2 text-[11px] text-slate-500">
    Minimal live dashboard — no client storage, no history. Built for low overhead.
  </footer>

  <script>
    // ---------- Config ----------
    const DATABASE_URL = document.getElementById("dbUrl").textContent.replace(/\/$/, "");
    const DATA_PATH = document.getElementById("dataPath").textContent;
    const DATA_URL_JSON = `${DATABASE_URL}${DATA_PATH}.json`;

    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);
    const fmt = (v, d = 2) => (isFinite(v) ? Number(v).toFixed(d) : "—");

    function setStatus(colorClass, text) {
      $("statusDot").className = `inline-block h-2.5 w-2.5 rounded-full ${colorClass}`;
      $("statusText").textContent = text;
    }

    // Light visual tick without layout thrash
    function tick(el, val) {
      el.classList.add("upd");
      el.textContent = val;
      // micro task to remove class after paint
      requestAnimationFrame(() => {
        el.classList.remove("upd");
      });
    }

    function paint(data) {
      if (!data || typeof data !== "object") return;
      if ("Vrms" in data) tick($("Vrms"), fmt(data.Vrms, 1));
      if ("Irms" in data) tick($("Irms"), fmt(data.Irms, 2));
      if ("RealPower" in data) tick($("RealPower"), fmt(data.RealPower, 1));
      if ("ApparentPower" in data) tick($("ApparentPower"), fmt(data.ApparentPower, 1));
      if ("PowerFactor" in data) tick($("PowerFactor"), fmt(data.PowerFactor, 2));
      if ("PhaseAngle_deg" in data) tick($("PhaseAngle_deg"), fmt(data.PhaseAngle_deg, 1));
      if ("Energy_kWh" in data) tick($("Energy_kWh"), fmt(data.Energy_kWh, 3));
      if ("Bill_Rs" in data) tick($("Bill_Rs"), fmt(data.Bill_Rs, 1));

      if ("Relay1" in data) {
        const r1 = $("Relay1");
        r1.textContent = data.Relay1 ? "ON" : "OFF";
        r1.className = `px-2 py-0.5 rounded-md ${data.Relay1 ? "bg-emerald-500/20 text-emerald-300" : "bg-slate-800 text-slate-300"} tick`;
      }
      if ("Relay2" in data) {
        const r2 = $("Relay2");
        r2.textContent = data.Relay2 ? "ON" : "OFF";
        r2.className = `px-2 py-0.5 rounded-md ${data.Relay2 ? "bg-emerald-500/20 text-emerald-300" : "bg-slate-800 text-slate-300"} tick`;
      }

      tick($("lastTs"), new Date().toLocaleTimeString());
    }

    // ---------- Live stream (no history kept) ----------
    let evtSource = null;
    let pollTimer = null;

    // Throttle UI paints to at most once every 500ms to avoid overload
    let pendingData = null;
    let lastPaint = 0;
    const PAINT_MIN_GAP_MS = 500;

    function schedulePaint(d) {
      pendingData = d;
      const now = performance.now();
      if (now - lastPaint >= PAINT_MIN_GAP_MS) {
        lastPaint = now;
        paint(pendingData);
        pendingData = null;
      } else {
        // defer to just after the gap
        const delay = Math.max(0, PAINT_MIN_GAP_MS - (now - lastPaint));
        setTimeout(() => {
          if (pendingData) {
            lastPaint = performance.now();
            paint(pendingData);
            pendingData = null;
          }
        }, delay);
      }
    }

    function startStream() {
      try {
        // Simple REST stream: text/event-stream delivering "put"/"patch" events
        evtSource = new EventSource(DATA_URL_JSON);
        setStatus("bg-yellow-400 animate-pulse", "Connecting…");

        evtSource.onopen = () => setStatus("bg-emerald-500", "Live");

        evtSource.onerror = () => {
          // Stop stream; go polling
          if (evtSource) evtSource.close();
          evtSource = null;
          setStatus("bg-sky-400", "Polling 4s");
          startPolling();
        };

        evtSource.onmessage = (e) => {
          try {
            const payload = JSON.parse(e.data);   // {event:"put"|..., data:{path:"/...", data:{...}}}
            const d = payload && payload.data ? payload.data : null;
            if (d && typeof d === "object") {
              schedulePaint(d);
            }
          } catch (_) {
            // ignore malformed lines
          }
        };
      } catch {
        setStatus("bg-sky-400", "Polling 4s");
        startPolling();
      }
    }

    function startPolling() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(pollOnce, 4000);
      pollOnce();
    }

    async function pollOnce() {
      try {
        const res = await fetch(DATA_URL_JSON, { cache: "no-store" });
        const d = await res.json();
        if (d && typeof d === "object") schedulePaint(d);
      } catch {
        setStatus("bg-red-500", "Offline");
      }
    }

    (function init() {
      startStream();
    })();
  </script>
</body>
</html>
